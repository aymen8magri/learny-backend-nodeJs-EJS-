<!-- ============================ Page Title Start ================================== -->
<section class="call-to-act" style="background:#ec780bd5 url(/img/landing-bg.png) no-repeat">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-lg-12 col-md-12">
        <h2 class="text-light">Formations Non Validées</h2>
        <span class="ipn-subtitle text-light">
          Dashboard Entreprise —
          <span style="color: #0c0101; font-weight: 600;">Formations en attente ou refusées</span>
        </span>
      </div>
    </div>
  </div>
</section>
<!-- ============================ Page Title End ================================== -->


<!-- ============================ Main Section Start ================================== -->
<section class="gray-bg py-5">
  <div class="container">
  


    <% if (formations.length === 0) { %>
      <div class="alert alert-info text-center shadow-sm">
        Aucune formation en attente ou refusée pour le moment.
      </div>
    <% } else { %>

      <!-- Barre de recherche et filtrage -->
      <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
        <div class="input-group w-auto">
          <input type="text" id="searchInput" class="form-control" placeholder="Rechercher une formation...">
          <button class="btn btn-dark" type="button"><i class="fa fa-search"></i></button>
        </div>

        <div class="dropdown">
          <button class="btn btn-outline-primary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fa fa-filter me-2"></i> Filtrer par statut
          </button>
          <ul class="dropdown-menu" aria-labelledby="filterDropdown">
            <li><a class="dropdown-item filter-option active" data-status="tous">Toutes</a></li>
            <li><a class="dropdown-item filter-option" data-status="En attente">En attente</a></li>
            <li><a class="dropdown-item filter-option" data-status="Refusée">Refusée</a></li>
          </ul>
        </div>
      </div>

      <!-- Messages flash -->
            <% if (success && success.length > 0) { %>
              <div class="alert alert-success alert-dismissible fade show text-center mt-3" role="alert">
                <strong><i class="fa fa-check-circle"></i> <%= success %></strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
              </div>
            <% } %>

      <!-- Tableau principal -->
      <table class="table table-striped table-bordered mt-4 align-middle text-center" id="formationsTable">
        <thead class="table-primary">
          <tr>
            <th>Image</th>
            <th>Titre</th>
            <th>Durée</th>
            <th>Prix</th>
            <th>Statut</th>
            <th>Date de création</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% formations.forEach(f => { %>
            <tr data-status="<%= f.status %>">
              <td>
                <img src="<%= f.image || '/img/co-4.jpg' %>"
                     class="img-fluid rounded"
                     width="70" height="50"
                     alt="<%= f.title %>">
              </td>
              <td><strong><%= f.title %></strong></td>
              <td><%= f.duration %> heures</td>
              <td><span class="text-success fw-bold"><%= f.price %> TND</span></td>
              <td>
                <% if (f.status === 'En attente') { %>
                  <span class="badge bg-warning text-dark px-3 py-2">En attente</span>
                <% } else if (f.status === 'Refusée') { %>
                  <span class="badge bg-danger px-3 py-2">Refusée</span>
                <% } %>
              </td>
              <td>
                <% 
                  const daysSinceCreation = Math.floor(
                    (Date.now() - new Date(f.createdAt)) / (1000 * 60 * 60 * 24)
                  );
                %>
                <%= daysSinceCreation === 0 ? 'Aujourd’hui' : 'Il y a ' + daysSinceCreation + ' jours' %>
              </td>
              <td>
                <div class="d-flex justify-content-center gap-2">

                  <!-- ajouter -->
                  <% if (f.status === 'Refusée') { %>
                  <form action="/formations/update/<%= f._id %>" method="POST"
                        style="display:inline;"
                        onsubmit="return confirm('Voulez-vous vraiment remettre cette formation en attente ?');">
                    <input type="hidden" name="status" value="En attente">
                    <button class="btn btn-success btn-sm" title="Ajouter">
                      <i class="fa fa-plus"></i>
                    </button>
                  </form>
                  <% } %>
                  <!-- Modifier -->
                  <form action="/responsable/formations/<%= f._id %>/edit" method="POST"
                        style="display:inline;"
                        onsubmit="return confirm('Voulez-vous vraiment modifier cette formation ?');">
                    <button class="btn btn-warning btn-sm text-dark" title="Modifier">
                      <i class="fa fa-edit"></i>
                    </button>
                  </form>

                  <!-- Supprimer -->
                  <form action="/formations/<%= f._id %>" method="POST"
                        style="display:inline;"
                        onsubmit="return confirm('Voulez-vous vraiment supprimer cette formation ?');">
                    <button class="btn btn-danger btn-sm" title="Supprimer">
                      <i class="fa fa-trash"></i>
                    </button>
                  </form>

                  <!-- Détails -->
                  <a href="/formations/all/<%= f._id %>" class="btn btn-info btn-sm" title="Détails">
                    <i class="fa fa-eye"></i>
                  </a>

                </div>
              </td>

            </tr>
          <% }) %>
        </tbody>
      </table>
    <% } %>
  </div>
</section>
<!-- ============================ Main Section End ================================== -->


<!-- ============================ Styles ============================ -->
<style>
  .gray-bg { background-color: #f9f9f9; }
  .table th {
    background-color: #0b85ec !important;
    color: white;
    vertical-align: middle;
  }
  .table td { vertical-align: middle; }
  .table-hover tbody tr:hover {
    background-color: #f1f7ff;
    transition: 0.2s;
  }
  .badge {
    font-size: 0.9em;
    border-radius: 8px;
  }
  .gap-2 {
    gap: 0.5rem;
  }
</style>

<!-- ============================ Script ============================ -->
<script>
  // Recherche
  document.getElementById('searchInput').addEventListener('input', function () {
    const search = this.value.toLowerCase();
    document.querySelectorAll('#formationsTable tbody tr').forEach(row => {
      const title = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
      row.style.display = title.includes(search) ? '' : 'none';
    });
  });

  // Filtrage
  document.querySelectorAll('.filter-option').forEach(opt => {
    opt.addEventListener('click', function() {
      document.querySelectorAll('.filter-option').forEach(o => o.classList.remove('active'));
      this.classList.add('active');
      const status = this.getAttribute('data-status');
      document.querySelectorAll('#formationsTable tbody tr').forEach(row => {
        const rowStatus = row.getAttribute('data-status');
        row.style.display = (status === 'tous' || rowStatus === status) ? '' : 'none';
      });
    });
  });

</script>
