<!-- ============================ Page Title Start ================================== -->
<section class="call-to-act" style="background:#0b85ec url(/img/landing-bg.png) no-repeat">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-lg-12 col-md-12">
        <h2 class="text-light">Formations Non Validées</h2>
        <span class="ipn-subtitle text-light">
          Dashboard Entreprise —
          <span style="color:#0c0101; font-weight:600;">Formations en attente ou refusées</span>
        </span>
      </div>
    </div>
  </div>
</section>
<!-- ============================ Page Title End ================================== -->

<!-- ============================ Main Section Start ================================== -->
<section class="gray-bg py-5">
  <div class="container">
    
    <% if (formations.length === 0) { %>
      <div class="alert alert-info text-center">
        Aucune formation en attente ou refusée pour le moment.
      </div>
    <% } else { %>

      <!-- Barre de recherche et filtrage -->
      <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
        <div class="input-group w-auto">
          <input type="text" id="searchInput" class="form-control" placeholder="Rechercher une formation...">
          <button class="btn btn-dark" type="button"><i class="fa fa-search"></i></button>
        </div>

        <div class="dropdown">
          <button class="btn btn-outline-primary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            Filtrer par statut
          </button>
          <ul class="dropdown-menu" aria-labelledby="filterDropdown">
            <li><a class="dropdown-item filter-option active" data-status="tous">Toutes</a></li>
            <li><a class="dropdown-item filter-option" data-status="En attente">En attente</a></li>
            <li><a class="dropdown-item filter-option" data-status="Refusée">Refusée</a></li>
          </ul>
        </div>
      </div>

      <!-- Tableau -->
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <table class="table table-hover align-middle" id="formationsTable">
            <thead class="table-dark">
              <tr>
                <th>Image</th>
                <th>Titre</th>
                <th>Durée</th>
                <th>Prix</th>
                <th>Status</th>
                <th>Date de création</th>
                <th>Actions</th>
              </tr>
            </thead>

            <tbody>
              <% formations.forEach(f => { %>
                <tr data-status="<%= f.status %>">
                  <td>
                    <img src="<%= f.image || '/img/co-4.jpg' %>" 
                         class="img-fluid rounded" 
                         width="70" height="50" 
                         alt="<%= f.title %>">
                  </td>

                  <td><strong><%= f.title %></strong></td>

                  <td><%= f.duration %> heures</td>

                  <td><span class="text-success fw-bold"><%= f.price %> TND</span></td>

                  <td>
                    <% if (f.status === 'En attente') { %>
                      <span class="badge bg-warning text-dark">En attente</span>
                    <% } else if (f.status === 'Refusée') { %>
                      <span class="badge bg-danger">Refusée</span>
                    <% } %>
                  </td>

                  <td>
                    <% 
                      const daysSinceCreation = Math.floor(
                        (Date.now() - new Date(f.createdAt)) / (1000 * 60 * 60 * 24)
                      );
                    %>
                    <%= daysSinceCreation === 0 ? 'Aujourd’hui' : 'Il y a ' + daysSinceCreation + ' jours' %>
                  </td>

                  <td>
                    <div class="dropdown">
                      <button class="btn btn-sm btn-light dropdown-toggle" 
                              type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fa fa-cog"></i>
                      </button>
                      <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/formations/<%= f._id %>">
                          <i class="fa fa-info-circle me-2"></i> Détails
                        </a></li>
                        <li><a class="dropdown-item" href="/entreprise/edit-formation/<%= f._id %>">
                          <i class="fa fa-edit me-2"></i> Modifier
                        </a></li>
                        <li><a class="dropdown-item text-danger" style="cursor:pointer;" onclick="supprimerFormation('<%= f._id %>')">
                          <i class="fa fa-trash me-2"></i> Supprimer
                        </a></li>
                      </ul>
                    </div>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>
    <% } %>
  </div>
</section>
<!-- ============================ Main Section End ================================== -->

<!-- ============================ Inline CSS + JS ============================ -->
<style>
  .table-hover tbody tr:hover { background-color: #f3f8ff; }
  .badge { font-size: 0.9em; padding: 6px 10px; border-radius: 8px; }
  .card { border-radius: 12px; }
  .filter-option.active { background-color: #0b85ec; color: white !important; }
</style>

<script>
  // Filtrage par texte
  document.getElementById('searchInput').addEventListener('input', function () {
    const search = this.value.toLowerCase();
    document.querySelectorAll('#formationsTable tbody tr').forEach(row => {
      const title = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
      row.style.display = title.includes(search) ? '' : 'none';
    });
  });

  // Filtrage par statut
  document.querySelectorAll('.filter-option').forEach(opt => {
    opt.addEventListener('click', function() {
      document.querySelectorAll('.filter-option').forEach(o => o.classList.remove('active'));
      this.classList.add('active');

      const status = this.getAttribute('data-status');
      document.querySelectorAll('#formationsTable tbody tr').forEach(row => {
        const rowStatus = row.getAttribute('data-status');
        if (status === 'tous' || rowStatus === status) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    });
  });

  // Supprimer une formation
  function supprimerFormation(id) {
    if (confirm("Voulez-vous vraiment supprimer cette formation ?")) {
      fetch(`/formations/${id}`, { method: 'DELETE' })
        .then(res => { if (res.ok) location.reload(); });
    }
  }
</script>
